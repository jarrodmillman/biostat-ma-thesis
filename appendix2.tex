\chapter{\label{app:def}Groups, actions, and orbits}
\setcounter{example}{0}

Groups are a basic object of study in abstract algebra and
are useful in many areas outside of mathematics \cite{armstrong1997groups, dummit2003abstract, lang2002algebra}.  They are intimately
related to the notion of symmetry.

\begin{definition}
A \emph{group} $(G, \cdot)$ is a set $G$ and a binary operation $\cdot: G \times G \to G$
called (group) \emph{multiplication} such that
\begin{enumerate}
\item $ab \in G$ for all $a, b \in G$ (i.e., $G$ is \emph{closed} under multiplication),
\item for all $a, b, c \in G$, $(ab)c = a(bc)$ (i.e., multiplication is \emph{associative}),
\item there exists an \emph{identity} element $e \in G$ such that $eg = ge = g$ for all $g \in G$, and
\item for each $g \in G$ there exists an \emph{inverse} element $g^{-1} \in G$ such that $g^{-1}g = gg^{-1} = e$.
\end{enumerate}
\end{definition}

Given a group $(G, \cdot)$, a subset $H$ of $G$ is called a subgroup if $(H, \cdot)$ is a group
under the multiplication of $G$.  The integers under
addition $(\mathbb{Z}, +)$ is a group with identity element $0$ and where the
inverse of $z$ is $-z$.  The even integers are a subgroup of $(\mathbb{Z}, +)$.
The rational numbers excluding $0$ under the multiplication
$(\mathbb{Q}\setminus \Set{0}, \cdot)$ is a group with identity element $1$ and
where the inverse of $p/q$ is $q/p$. In both cases, it is easy to verify that
the group properties are met.  Here is a more complicated example that we will
use in the sequel. 

\begin{example}
A permutation of an arbitrary set $\CX$ is a bijection from $\CX$ to itself.  The
set $S_\CX$ of all permutations of $\CX$ under function composition
$(S_\CX, \smallcirc)$ is a group.  The associativity of permutations follows from the
associativity of function composition.  The bijection taking every element of
$\CX$ to itself is the identity permutation. Since a permutation is a bijective function, the
inverse of every permutation exists and operates from both left and right.  
If $\CX = \Set{1, 2, \dots, n}$, then $S_\CX$ is the symmetry group of order $n$
and is usually denoted $S_n$.
\end{example}


\begin{definition}
Let $G$ and $H$ be groups.  A \emph{homeomorphism} $\varphi: G \to H$ takes multiplication
from $G$ to $H$ such that $\varphi(xy) = \varphi(x)\varphi(y)$ for all $x, y \in G$.
\end{definition}

Note that the multiplication on $G$ and the multiplication on $H$ may be completely different operations
and in general $\varphi(x)y$ will be undefined.
To make that explicit, let $(G, \star)$ and $(H, \diamond)$ be groups then we write the
condition for a function $\varphi: G \to H$ to be a homeomorphism as
$\varphi(x \star y) = \varphi(x)  \diamond \varphi(y)$.  
Since the context will make clear the group multiplication being used, we will not usually
distinguish the different  operators.
A homeomorphism takes the identity of $G$ to the identity of $H$
since $\varphi(g) = \varphi(ge) = \varphi(g)\varphi(e)$ for all $g \in G$. It takes inverses to 
inverses since $\varphi(e) = \varphi(g^{-1}g) = \varphi(g^{-1})\varphi(g)$ for all $g \in G$.
If $\varphi$ is a bijection, then it is called an isomorphism.

\begin{definition}
An \emph{action} of a group $G$ on a set $\CX$ is a homeomorphism $\varphi: G \to S_\CX$.
\end{definition}

We say an action since a group $G$ can act on $\CX$ in more than one way. Recalling the
definition of a homeomorphism, this means that $\varphi(xy) = \varphi(x)\varphi(y)$ for all
$x, y \in G$ where $\varphi(xy), \varphi(x), \varphi(y) \in S_\CX$.  Also notice that
$\varphi(x)\varphi(y)$ represents composition of the permutations $\varphi(x)$ and 
$\varphi(y)$.  Moreover, $\varphi(e)$ is the identity permutation in $S_\CX$.
It is standard to write $gx$ instead of $\varphi(g)(x)$ since it is more compact.
Note that $gx$ is not ``multiplying'' an element $g$ of $G$ with an element $x$ of $\CX$,
but represents the group action
of $g$ on $x$, which can be thought of as the image of $x$ under the permutation of $\CX$
induced by $g$.  Each $g \in G$ corresponds to a permutation of $\CX$ defined by the
homeomorphism.

%\begin{definition}
%An \emph{action} of a group $G$ on a set $\CX$ is a set of permutations $\pi_g: \CX \to \CX$ for $g \in G$ such that
%
%(1) $\pi_e$ is the identity (i.e., for every $x \in \CX, \pi_e(x) = x$) and
%
%(2) for every $g_1$ and $g_2$ in $G$, $\pi_{g_1} \smallcirc \pi_{g_2} = \pi_{g_1g_2}$.
%\end{definition}



\begin{definition}
The \emph{orbit} $G(x) \equiv \Set{gx  \given g \in G}$ of any $x$ in $\CX$ is
the set of all images of the particular point $x$ under all elements of $G$.
\end{definition}

%The set of all the points in an orbit form an equivalence relations under the group action.
%The set of all such equivalence relations partitions $\CX$ by a subgroup of
%$S_\CX$ under composition endowed with the group structure of $G$.

\begin{example}
The additive group $(\mathbb{Z}, +)$ acts on the real line $\mathbb{R}$ by translation.
That is, for every integer $z$ and any real number $x$ the group action is given
by $x \mapsto z + x$. To show that this a homeomorphism $\varphi : (\mathbb{Z}, +) \to (S_\mathbb{R}, \smallcirc)$,
note that given any two integers $m$ and $n$ and any real number $x$ the following
holds $(m + n) + x = m + (n + x)$.  The orbit of $\pi$ (i.e., $3.14152...$) under
this group action is
\begin{align*}
\Set{z\pi  \given z \in \mathbb{Z}} = \Set{z + \pi  \given z \in \mathbb{Z}} =\Set{\dots, 2.14152..., 3.14152..., 4.14152..., \dots}.
\end{align*}
In a similar fashion, the orbit of any real number $x$ under this action of $(\mathbb{Z}, +)$
on $\mathbb{R}$ creates and equivalence relation under the group structure of $(\mathbb{Z}, +)$ such
that $x \sim y$ with $y$ in $\mathbb{R}$ exactly when there exists a $z$ in $\mathbb{Z}$ such that
$y = z + x$.
\end{example}

The set of all orbits as $x$ ranges over $\CX$ is a partition of $\CX$ into equivalence classes.
The relevance for permutation tests is as follows: Suppose that $\CX$ is the outcome
space of some experiment, and we will make an observation $X$ drawn from $P$.
Let $(G, \cdot)$ be a group that acts on $\CX$.
Suppose that under the null hypothesis, all elements of $\CX$ in any given orbit under $G$ 
are equally likely.
Then if we observe $X=x$, it is just as likely that we would have observed $gx$ for any
$g \in G$: conditional on the orbit $Gx$, all elements of $Gx$ are equally likely.
This then determines the (conditional) distribution of $X$: every element of $Gx$ is equally
likely given $GX = Gx$---even though we do not know $P(X \in Gx)$.
The uniform conditional distribution lets us calculate the conditional null distribution of
any test statistic.

\begin{thm}
Given a probability space $(\mathcal{X}, \Sigma, \mu)$ and a group $(G, \cdot)$
acting on $\mathcal{X}$ such  $\Sigma$ is closed under the action of $G$,  
let $X \sim P$ for some unknown $P$ dominated by $\mu$.
Consider testing the hypothesis that $P$ is invariant under $G$:
\begin{align*}
H_0: P(S \subset \mathcal{X}) = P(GS  \subset \mathcal{X}) \text{  for all }S \in \Sigma.
\end{align*}
Suppose we have a family of tests with (conditional) level no greater than $\alpha$ conditional on the orbit of
the observed data
\begin{align*}
P(\text{reject }H_0 | GX=Gx \| H_0) \le \alpha,
\end{align*}
where ``$\| H_0$'' means ``computed on the assumption that $H_0$ is true''.
Then the resulting overall test has unconditional level no greater than $\alpha$:
\begin{align*}
P(\text{reject }H_0  \| H_0) \le \alpha.
\end{align*}
%If tests are performed conditionally at level α regardless of the observed data, the
%resulting overall test has unconditional level α, by the law of total probability. 
\end{thm}

\begin{proof}
By the law of total probability, we have
\begin{align*}
P(\text{reject }H_0  \| H_0) &= \int_\mathcal{X} P(\text{reject }H_0 | GX=Gx \| H_0)P(GX=Gx \| H_0)d\mu(x) \\
  &\le \int_\mathcal{X} \alpha P(GX=Gx \| H_0)d\mu(x) \\
  &= \alpha \int_\mathcal{X} P(GX=Gx \| H_0)d\mu(x) \\
  &= \alpha.  \qedhere
\end{align*}
\end{proof}
